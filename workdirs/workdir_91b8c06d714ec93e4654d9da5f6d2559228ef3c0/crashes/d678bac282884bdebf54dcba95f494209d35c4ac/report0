======================================================
WARNING: possible circular locking dependency detected
5.10.0-rc2-next-20201104-syzkaller #0 Not tainted
------------------------------------------------------
syz-executor.2/14315 is trying to acquire lock:
ffffffff8b249500 (console_owner){..-.}-{0:0}, at: console_unlock+0x341/0xbc0 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2474

but task is already holding lock:
ffffffff8f9c37f8 (&port->lock){-...}-{2:2}, at: tty_port_close_start+0x50/0x530 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:567

which lock already depends on the new lock.


the existing dependency chain (in reverse order) is:

-> #2 (&port->lock){-...}-{2:2}:
       __raw_spin_lock_irqsave root/ramdisk/work_dir/linux/./include/linux/spinlock_api_smp.h:110 [inline]
       _raw_spin_lock_irqsave+0x36/0x50 root/ramdisk/work_dir/linux/kernel/locking/spinlock.c:159
       tty_port_tty_get+0x1f/0x100 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:288
       tty_port_default_wakeup+0x11/0x40 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:47
       serial8250_tx_chars+0x48c/0xad0 root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_port.c:1832
       serial8250_handle_irq.part.0+0x365/0x420 root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_port.c:1919
       serial8250_handle_irq root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_port.c:1892 [inline]
       serial8250_default_handle_irq+0xb2/0x220 root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_port.c:1935
       serial8250_interrupt+0xfd/0x200 root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_core.c:126
       __handle_irq_event_percpu+0x303/0x900 root/ramdisk/work_dir/linux/kernel/irq/handle.c:156
       handle_irq_event_percpu root/ramdisk/work_dir/linux/kernel/irq/handle.c:196 [inline]
       handle_irq_event+0x102/0x290 root/ramdisk/work_dir/linux/kernel/irq/handle.c:213
       handle_edge_irq+0x25d/0xcf0 root/ramdisk/work_dir/linux/kernel/irq/chip.c:819
       asm_call_irq_on_stack+0xf/0x20
       __run_irq_on_irqstack root/ramdisk/work_dir/linux/./arch/x86/include/asm/irq_stack.h:48 [inline]
       run_irq_on_irqstack_cond root/ramdisk/work_dir/linux/./arch/x86/include/asm/irq_stack.h:101 [inline]
       handle_irq root/ramdisk/work_dir/linux/arch/x86/kernel/irq.c:230 [inline]
       __common_interrupt root/ramdisk/work_dir/linux/arch/x86/kernel/irq.c:249 [inline]
       common_interrupt+0x11a/0x1d0 root/ramdisk/work_dir/linux/arch/x86/kernel/irq.c:239
       asm_common_interrupt+0x1e/0x40 root/ramdisk/work_dir/linux/./arch/x86/include/asm/idtentry.h:622
       native_restore_fl root/ramdisk/work_dir/linux/./arch/x86/include/asm/irqflags.h:41 [inline]
       arch_local_irq_restore root/ramdisk/work_dir/linux/./arch/x86/include/asm/irqflags.h:84 [inline]
       __raw_spin_unlock_irqrestore root/ramdisk/work_dir/linux/./include/linux/spinlock_api_smp.h:160 [inline]
       _raw_spin_unlock_irqrestore+0x25/0x50 root/ramdisk/work_dir/linux/kernel/locking/spinlock.c:191
       spin_unlock_irqrestore root/ramdisk/work_dir/linux/./include/linux/spinlock.h:409 [inline]
       uart_write+0x33b/0x620 root/ramdisk/work_dir/linux/drivers/tty/serial/serial_core.c:615
       process_output_block root/ramdisk/work_dir/linux/drivers/tty/n_tty.c:595 [inline]
       n_tty_write+0x422/0x11b0 root/ramdisk/work_dir/linux/drivers/tty/n_tty.c:2333
       do_tty_write root/ramdisk/work_dir/linux/drivers/tty/tty_io.c:962 [inline]
       tty_write+0x511/0x8a0 root/ramdisk/work_dir/linux/drivers/tty/tty_io.c:1046
       redirected_tty_write+0xa8/0xb0 root/ramdisk/work_dir/linux/drivers/tty/tty_io.c:1067
       vfs_write+0x270/0x6f0 root/ramdisk/work_dir/linux/fs/read_write.c:603
       ksys_write+0x131/0x250 root/ramdisk/work_dir/linux/fs/read_write.c:658
       do_syscall_64+0x2d/0x70 root/ramdisk/work_dir/linux/arch/x86/entry/common.c:46
       entry_SYSCALL_64_after_hwframe+0x44/0xa9

-> #1 (&port_lock_key){-.-.}-{2:2}:
       __raw_spin_lock_irqsave root/ramdisk/work_dir/linux/./include/linux/spinlock_api_smp.h:110 [inline]
       _raw_spin_lock_irqsave+0x36/0x50 root/ramdisk/work_dir/linux/kernel/locking/spinlock.c:159
       serial8250_console_write+0x892/0xaa0 root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_port.c:3292
       call_console_drivers root/ramdisk/work_dir/linux/kernel/printk/printk.c:1885 [inline]
       console_unlock+0x773/0xbc0 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2499
       register_console root/ramdisk/work_dir/linux/kernel/printk/printk.c:2840 [inline]
       register_console+0x57c/0x840 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2730
       univ8250_console_init+0x37/0x41 root/ramdisk/work_dir/linux/drivers/tty/serial/8250/8250_core.c:690
       console_init+0x3c7/0x596 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2950
       start_kernel+0x2f6/0x487 root/ramdisk/work_dir/linux/init/main.c:980
       secondary_startup_64_no_verify+0xb0/0xbb

-> #0 (console_owner){..-.}-{0:0}:
       check_prev_add root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:2864 [inline]
       check_prevs_add root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:2989 [inline]
       validate_chain root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:3607 [inline]
       __lock_acquire+0x28c0/0x5eb0 root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:4831
       lock_acquire root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:5436 [inline]
       lock_acquire+0x295/0x8a0 root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:5401
       console_lock_spinning_enable root/ramdisk/work_dir/linux/kernel/printk/printk.c:1737 [inline]
       console_unlock+0x3c2/0xbc0 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2496
       vprintk_emit+0x19c/0x4a0 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2028
       vprintk_func+0x8d/0x1d0 root/ramdisk/work_dir/linux/kernel/printk/printk_safe.c:393
       printk+0xba/0xeb root/ramdisk/work_dir/linux/kernel/printk/printk.c:2076
       tty_port_close_start+0x4aa/0x530 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:569
       tty_port_close+0x22/0x160 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:634
       tty_release+0x46b/0x1300 root/ramdisk/work_dir/linux/drivers/tty/tty_io.c:1679
       __fput+0x270/0x8e0 root/ramdisk/work_dir/linux/fs/file_table.c:280
       task_work_run+0xdd/0x190 root/ramdisk/work_dir/linux/kernel/task_work.c:140
       tracehook_notify_resume root/ramdisk/work_dir/linux/./include/linux/tracehook.h:188 [inline]
       exit_to_user_mode_loop root/ramdisk/work_dir/linux/kernel/entry/common.c:172 [inline]
       exit_to_user_mode_prepare+0x1e8/0x1f0 root/ramdisk/work_dir/linux/kernel/entry/common.c:199
       syscall_exit_to_user_mode+0x38/0x260 root/ramdisk/work_dir/linux/kernel/entry/common.c:274
       entry_SYSCALL_64_after_hwframe+0x44/0xa9

other info that might help us debug this:

Chain exists of:
  console_owner --> &port_lock_key --> &port->lock

 Possible unsafe locking scenario:

       CPU0                    CPU1
       ----                    ----
  lock(&port->lock);
                               lock(&port_lock_key);
                               lock(&port->lock);
  lock(console_owner);

 *** DEADLOCK ***

3 locks held by syz-executor.2/14315:
 #0: ffff8880462081c0 (&tty->legacy_mutex){+.+.}-{3:3}, at: tty_lock+0xbc/0x120 root/ramdisk/work_dir/linux/drivers/tty/tty_mutex.c:19
 #1: ffffffff8f9c37f8 (&port->lock){-...}-{2:2}, at: tty_port_close_start+0x50/0x530 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:567
 #2: ffffffff8b329880 (console_lock){+.+.}-{0:0}, at: vprintk_func+0x8d/0x1d0 root/ramdisk/work_dir/linux/kernel/printk/printk_safe.c:393

stack backtrace:
CPU: 1 PID: 14315 Comm: syz-executor.2 Not tainted 5.10.0-rc2-next-20201104-syzkaller #0
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
Call Trace:
 __dump_stack root/ramdisk/work_dir/linux/lib/dump_stack.c:77 [inline]
 dump_stack+0x107/0x163 root/ramdisk/work_dir/linux/lib/dump_stack.c:118
 check_noncircular+0x268/0x310 root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:2115
 check_prev_add root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:2864 [inline]
 check_prevs_add root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:2989 [inline]
 validate_chain root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:3607 [inline]
 __lock_acquire+0x28c0/0x5eb0 root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:4831
 lock_acquire root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:5436 [inline]
 lock_acquire+0x295/0x8a0 root/ramdisk/work_dir/linux/kernel/locking/lockdep.c:5401
 console_lock_spinning_enable root/ramdisk/work_dir/linux/kernel/printk/printk.c:1737 [inline]
 console_unlock+0x3c2/0xbc0 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2496
 vprintk_emit+0x19c/0x4a0 root/ramdisk/work_dir/linux/kernel/printk/printk.c:2028
 vprintk_func+0x8d/0x1d0 root/ramdisk/work_dir/linux/kernel/printk/printk_safe.c:393
 printk+0xba/0xeb root/ramdisk/work_dir/linux/kernel/printk/printk.c:2076
 tty_port_close_start+0x4aa/0x530 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:569
 tty_port_close+0x22/0x160 root/ramdisk/work_dir/linux/drivers/tty/tty_port.c:634
 tty_release+0x46b/0x1300 root/ramdisk/work_dir/linux/drivers/tty/tty_io.c:1679
 __fput+0x270/0x8e0 root/ramdisk/work_dir/linux/fs/file_table.c:280
 task_work_run+0xdd/0x190 root/ramdisk/work_dir/linux/kernel/task_work.c:140
 tracehook_notify_resume root/ramdisk/work_dir/linux/./include/linux/tracehook.h:188 [inline]
 exit_to_user_mode_loop root/ramdisk/work_dir/linux/kernel/entry/common.c:172 [inline]
 exit_to_user_mode_prepare+0x1e8/0x1f0 root/ramdisk/work_dir/linux/kernel/entry/common.c:199
 syscall_exit_to_user_mode+0x38/0x260 root/ramdisk/work_dir/linux/kernel/entry/common.c:274
 entry_SYSCALL_64_after_hwframe+0x44/0xa9
RIP: 0033:0x7f74e7ff5ea9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 e1 20 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f74e65760c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000101
RAX: ffffffffffffffea RBX: 00007f74e8123f80 RCX: 00007f74e7ff5ea9
RDX: 0000000000006400 RSI: 0000000020000000 RDI: ffffffffffffff9c
RBP: 00007f74e804247a R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 000000000000000b R14: 00007f74e8123f80 R15: 00007fffae5f7538
